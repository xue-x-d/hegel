<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap  PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"  "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 商品分析 -->
<sqlMap namespace="itemMapping">

	<typeAlias alias="SItem" type="com.shomop.crm.model.SItem" />
	<typeAlias alias="ItemAnalysis" type="com.shomop.crm.model.ItemAnalysis" />
	<!-- order返回字段 -->
    <sql id="orderFields">select t.tid,t.buyerNick,o.payment,o.numIid,o.num,o.status,o.created from </sql>
    <sql id="itemAnalysisFields"> select ia.id,ia.user,ia.numIid,ia.firstSaleTime,ia.lastSaleTime,ia.totalAmountNum,ia.returnedSaleNum,ia.returnedAmountNum,ia.updateTime from item_analysis ia </sql>
    
    <!-- 查询item分析结果 -->
    <sql id="queryItemAnalysis">
     <isParameterPresent>
      <isNotEmpty prepend="and" property="user">
	      <![CDATA[ia.user=#user#]]>
	  </isNotEmpty>
	  <isNotEmpty prepend="and" property="numIid">
	      <![CDATA[ia.numIid=$numIid$]]>
	  </isNotEmpty>
      </isParameterPresent>
    </sql>
    
	<!-- 指定时间付款的子订单 (订单可能没有对应的order存在)-->
	<select id="getPayOrdersByTimeOfUser" parameterClass="HashMap">
      <include refid="orderFields"/><![CDATA[trade t left join orders o on t.tid=o.tid and o.created > 0]]>
		<dynamic prepend="where">
			<include refid="queryPayTrade" />
			<![CDATA[ and o.id is not null]]>
		</dynamic>
	</select> 

   <!-- 获取指定时间付款子订单buyerNick在该店铺的其他子订单 trade关联自身查询，然后关联orders-->
   <select id="getAssociateBuyerNickOrdersOfUser" parameterClass="HashMap">
      <include refid="orderFields"/><![CDATA[(select tt.tid,tt.buyerNick,tt.payTime from (select t.buyerNick,min(t.created) as created from trade t]]>
      <dynamic prepend="where" close=")">
		 <include refid="queryPayTrade" />
		 <![CDATA[group by t.buyerNick]]>
	  </dynamic>
      <![CDATA[t ,trade tt where tt.buyerNick=t.buyerNick and tt.created < t.created and tt.user=#user#) t left join orders o on t.tid=o.tid where where t.payTime != '']]>
   </select>
   
   <!-- 指定付款时间段内的回头购买用户的所有以前购买宝贝列表-->
   <select id="getReturnedBuyerNicksAndNumIdsByTime" parameterClass="HashMap">
      <![CDATA[select t.buyerNick,o.numIid,count(o.oid) as times from (select tt.tid,tt.buyerNick,tt.payTime from (select t.buyerNick,min(t.created) as created from trade t]]>
      <dynamic prepend="where" close=")">
		 <include refid="queryPayTrade" />
		 <![CDATA[group by t.buyerNick]]>
	  </dynamic>
	  <![CDATA[t,trade tt where tt.buyerNick=t.buyerNick and tt.created < t.created and tt.user=#user#) t left join orders o on t.tid=o.tid where t.payTime !='' group by t.buyerNick,o.numIid having times >= 1]]>
   </select>

  <!-- 历史订单中的每天付款的order
  <select id="getHistoryPayOrdersByTimeOfUser" parameterClass="HashMap">
     <include refid="orderFields"/><![CDATA[trade t LEFT JOIN orders o on t.tid=o.tid ]]>
     <dynamic prepend="where" close=")">
		 <include refid="queryPayTrade" />
	 </dynamic>
  </select> -->
  <!-- 查询指定numIid的商品分析结果 -->
   <select id="getItemAnalysisByNumIids" parameterClass="list">
	<include refid="itemAnalysisFields" />
	 <dynamic prepend="where">
		<isParameterPresent>
		<![CDATA[ia.numIid in ]]>
		<iterate open="(" close=")" conjunction=",">$[]$</iterate>
		</isParameterPresent>
	 </dynamic>
   </select>

</sqlMap>
