<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 每日营销数据、营销效果分析 -->
<sqlMap namespace="marketingStatistic">
	<!-- 付款状态 -->
	<sql id="tradeStatus">'WAIT_SELLER_SEND_GOODS','WAIT_BUYER_CONFIRM_GOODS','TRADE_BUYER_SIGNED','TRADE_FINISHED' </sql>
	
	<select id="marketingSMSResult" resultClass="java.util.HashMap">
      <![CDATA[select IFNULL(sum(t.payment),0) as amount,count(DISTINCT t.tid) as tradeSize from 
      (select r.id,min(r.sendTime) as minSendTime,d.mobileNo from send_record r left join send_detail d on r.id = d.sendRecord where (r.type & 15)=0 and r.status<100 and (r.sendTime BETWEEN #earlyTime# AND #endTime#) 
      and r.user=#userId# and d.status<100 group by d.mobileNo) d inner join  trade t 
      on t.receiverMobile=d.mobileNo and t.created > d.minSendTime where (t.created BETWEEN #startTime# AND #endTime#) and t.payTime !='' and t.user=#userId#
      ]]>
	</select>
	
	<select id="marketingSMSCount" resultClass="java.util.HashMap">
       <![CDATA[select count(*) as messageCount  from send_record r left join send_detail d on r.id = d.sendRecord where (r.type & 15)=0 and r.status<100 
       and (r.sendTime BETWEEN #startTime# AND #endTime#) and d.status<100 and r.user=#userId#
       ]]>
	</select>
	
	<select id="notifySMSResult" resultClass="java.util.HashMap">
       <![CDATA[select IFNULL(sum(t.payment),0) as amount,count(DISTINCT t.tid) as tradeSize from 
       (select n.mobileNo,n.user, min(n.sendTime) as minSendTime from notify_sms as n where (n.sendTime BETWEEN #earlyTime# AND #endTime#) and n.status>=0 and n.status<100 and n.deleted=0 and n.tid is not null group by n.mobileNo)
        d inner join trade t on t.user = d.user and t.receiverMobile=d.mobileNo and t.created > d.minSendTime where (t.created BETWEEN #startTime# AND #endTime#) and t.payTime !='' and t.user=#userId#
       ]]>
	</select>
	
	<select id="notifySMSCount" resultClass="java.util.HashMap">
       <![CDATA[select count(*) as messageCount from notify_sms as n where (n.sendTime BETWEEN #startTime# AND #endTime#) and n.status>=0 and n.status<100 and n.tid is not null and user=#userId#]]>
	</select>
	
</sqlMap>